name: Discord Deployment Notifications

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  deployment_status:

jobs:
  notify-start:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changes
        run: |
          echo "files=$(git diff --name-only HEAD^ HEAD | head -5 | tr '\n' ', ' | sed 's/,$//')" >> $GITHUB_OUTPUT
          echo "file_count=$(git diff --name-only HEAD^ HEAD | wc -l)" >> $GITHUB_OUTPUT

      - name: Get commit stats
        id: stats
        run: |
          echo "additions=$(git diff --shortstat HEAD^ HEAD | grep -o '[0-9]* insertion' | cut -d' ' -f1 || echo '0')" >> $GITHUB_OUTPUT
          echo "deletions=$(git diff --shortstat HEAD^ HEAD | grep -o '[0-9]* deletion' | cut -d' ' -f1 || echo '0')" >> $GITHUB_OUTPUT

      - name: Notify Deployment Started
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üöÄ Deployment Started"
          description: |
            **Project:** rosendohq
            **Branch:** `${{ github.ref_name }}`
            **Author:** ${{ github.actor }}
            **Commit:** [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Message:** ${{ github.event.head_commit.message }}

            **üìä Changes:**
            ‚Ä¢ **Files changed:** ${{ steps.changes.outputs.file_count }}
            ‚Ä¢ **Lines added:** +${{ steps.stats.outputs.additions }}
            ‚Ä¢ **Lines removed:** -${{ steps.stats.outputs.deletions }}

            **üìÅ Modified files:** ${{ steps.changes.outputs.files }}
          color: 0xffa500
          username: "GitHub Deploy Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

  notify-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR stats
        id: pr_stats
        run: |
          echo "commits=$(echo '${{ github.event.pull_request.commits }}')" >> $GITHUB_OUTPUT
          echo "additions=$(echo '${{ github.event.pull_request.additions }}')" >> $GITHUB_OUTPUT
          echo "deletions=$(echo '${{ github.event.pull_request.deletions }}')" >> $GITHUB_OUTPUT
          echo "changed_files=$(echo '${{ github.event.pull_request.changed_files }}')" >> $GITHUB_OUTPUT

      - name: Notify Pull Request
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üìù New Pull Request"
          description: |
            **PR:** [${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})
            **Author:** ${{ github.actor }}
            **Branch:** `${{ github.head_ref }}` ‚Üí `${{ github.base_ref }}`

            **üìä PR Stats:**
            ‚Ä¢ **Commits:** ${{ steps.pr_stats.outputs.commits }}
            ‚Ä¢ **Files changed:** ${{ steps.pr_stats.outputs.changed_files }}
            ‚Ä¢ **Lines:** +${{ steps.pr_stats.outputs.additions }} / -${{ steps.pr_stats.outputs.deletions }}
          color: 0x00aaff
          username: "GitHub PR Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

  # This job listens to Vercel deployment status changes
  vercel-deployment-status:
    runs-on: ubuntu-latest
    if: github.event_name == 'deployment_status'
    steps:
      - name: Get deployment time
        id: timing
        run: |
          echo "deployed_at=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Notify Deployment Success
        if: github.event.deployment_status.state == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚úÖ Deployment Successful"
          description: |
            **Project:** rosendohq
            **Environment:** üåç ${{ github.event.deployment.environment }}
            **Live URL:** [${{ github.event.deployment.payload.web_url || 'rosendohq.vercel.app' }}](${{ github.event.deployment.payload.web_url || 'https://rosendohq.vercel.app' }})
            **Deployed at:** ${{ steps.timing.outputs.deployed_at }}

            **üîó Quick Links:**
            ‚Ä¢ [View Site](${{ github.event.deployment.payload.web_url || 'https://rosendohq.vercel.app' }})
            ‚Ä¢ [Vercel Dashboard](https://vercel.com/dashboard)
            ‚Ä¢ [Commit Details](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

            **üì± Test your deployment:**
            ‚Ä¢ Desktop: [${{ github.event.deployment.payload.web_url || 'rosendohq.vercel.app' }}](${{ github.event.deployment.payload.web_url || 'https://rosendohq.vercel.app' }})
            ‚Ä¢ Mobile view: Check responsive design
          color: 0x00ff00
          username: "Vercel Deploy Bot"
          avatar_url: "https://assets.vercel.com/image/upload/front/favicon/vercel/favicon.ico"

      - name: Notify Deployment Failure
        if: github.event.deployment_status.state == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚ùå Deployment Failed"
          description: |
            **Project:** rosendohq
            **Environment:** üî¥ ${{ github.event.deployment.environment }}
            **Author:** ${{ github.actor }}
            **Commit:** [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

            **üîç Debug Links:**
            ‚Ä¢ [GitHub Actions Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ‚Ä¢ [Vercel Dashboard](https://vercel.com/dashboard)
            ‚Ä¢ [Deployment Details](${{ github.event.deployment_status.target_url }})

            **‚ö†Ô∏è Action Required:** Check the Vercel deployment logs to diagnose the issue.

            **Error Details:**
            ‚Ä¢ **Status:** ${{ github.event.deployment_status.state }}
            ‚Ä¢ **Description:** ${{ github.event.deployment_status.description }}
          color: 0xff0000
          username: "Vercel Deploy Bot"
          avatar_url: "https://assets.vercel.com/image/upload/front/favicon/vercel/favicon.ico"

      - name: Notify Deployment Error
        if: github.event.deployment_status.state == 'error'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üö® Deployment Error"
          description: |
            **Project:** rosendohq
            **Environment:** ‚ö†Ô∏è ${{ github.event.deployment.environment }}
            **Author:** ${{ github.actor }}
            **Commit:** [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

            **üîç Debug Links:**
            ‚Ä¢ [GitHub Actions Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ‚Ä¢ [Vercel Dashboard](https://vercel.com/dashboard)
            ‚Ä¢ [Deployment Details](${{ github.event.deployment_status.target_url }})

            **üí• Critical Error:** The deployment encountered a system error.

            **Error Details:**
            ‚Ä¢ **Status:** ${{ github.event.deployment_status.state }}
            ‚Ä¢ **Description:** ${{ github.event.deployment_status.description }}
          color: 0x800000
          username: "Vercel Deploy Bot"
          avatar_url: "https://assets.vercel.com/image/upload/front/favicon/vercel/favicon.ico"
